const express = require("express");
const dotenv = require("dotenv");
const connectDB = require("./config/db");
const userRoutes = require("./routes/userRoutes");
const messageRoutes = require("./routes/messageRoutes");
const friendRoutes = require("./routes/friendRoutes");
const groupRoutes = require("./routes/groupRoutes");
const UserModel = require("./models/UserModel");
const MessageModel = require("./models/MessageModel");
const qrRoutes = require("./routes/qrRoutes");
const cors = require("cors");
const morgan = require("morgan");
const http = require("http");
const { Server } = require("socket.io");
const {
  setSocketIO,
  setUserOnline,
  removeUserBySocketId,
  getOnlineUsers,
} = require("./utils/socket");

dotenv.config();
connectDB();

const app = express();
// app.use(cors());/
app.use(
  cors({
    origin: ["http://localhost:5173", "http://localhost:3000"],
    methods: ["GET", "POST", "PUT", "DELETE"],
  })
);

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(morgan("dev"));

app.use("/api/users", userRoutes);
app.use("/api/messages", messageRoutes);
app.use("/api/friends", friendRoutes);
app.use("/api/groups", groupRoutes);
app.use("/api/qr", qrRoutes);
const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: ["http://localhost:5173", "http://localhost:3000"], // Ch·ªânh l·∫°'i n·∫øu c·∫ßn (v√≠ d·ª•: 'http://localhost:3000')
    methods: ["GET", "POST", "PUT", "DELETE"],
  },
});
setSocketIO(io);

// L∆∞u ng∆∞·ªùi d√πng online
// global.onlineUsers = new Map();

io.on("connection", (socket) => {
  console.log("‚úÖ Socket connected:", socket.id);

  socket.on("add-user", async (userId) => {
    console.log("üü¢ User connected:", userId);
    try {
      await UserModel.findByIdAndUpdate(userId, { status: "online" });
      console.log(`User ${userId} is online`);
      setUserOnline(userId, socket.id);
      console.log(
        "Current online users:",
        Array.from(getOnlineUsers().entries())
      );
      io.emit("userStatusUpdate", { userId, status: "online" });
    } catch (error) {
      console.error("Error updating user status to online:", error);
    }
  });
  // socket.on("send-group-msg", async (data) => {
  //   const {
  //     groupId,
  //     from,
  //     message,
  //     createdAt,
  //     isImage,
  //     fileUrls,
  //     _id,
  //     replyTo,
  //   } = data;

  //   console.log(
  //     `üì§ [Socket.IO] Received send-group-msg event - From: ${from} - GroupId: ${groupId} - Message ID: ${_id}`
  //   );

  //   try {
  //     // Find the group and its members
  //     const group = await groupModel.findById(groupId);
  //     if (!group) {
  //       console.error(`Group not found: ${groupId}`);
  //       return;
  //     }

  //     // Get sender's name for display
  //     const sender = await UserModel.findById(from);
  //     const senderName = sender ? sender.fullName : "Unknown";

  //     // Send message to all group members except the sender
  //     const onlineUsers = getOnlineUsers();
  //     group.groupMembers.forEach((memberId) => {
  //       const memberIdStr = memberId.toString();
  //       if (memberIdStr !== from) {
  //         const memberSocketId = onlineUsers.get(memberIdStr);
  //         if (memberSocketId) {
  //           console.log(
  //             `üì• [Socket.IO] Emitting group-msg-receive to member - To: ${memberIdStr} - Socket ID: ${memberSocketId}`
  //           );

  //           io.to(memberSocketId).emit("group-msg-receive", {
  //             groupId,
  //             from,
  //             senderName,
  //             message,
  //             createdAt,
  //             isImage: isImage || false,
  //             fileUrls: fileUrls || [],
  //             _id,
  //             replyTo,
  //           });
  //         }
  //       }
  //     });
  //   } catch (error) {
  //     console.error("Error processing group message:", error);
  //   }
  // });
  // // G·ª≠i tin nh·∫Øn realtime
  // socket.on("send-msg", async (data) => {
  //   const { from, to, message, createdAt, isImage, fileUrls, _id } = data;

  //   // Log khi nh·∫≠n s·ª± ki·ªán send-msg, bao g·ªìm n·ªôi dung tin nh·∫Øn
  //   console.log(
  //     `üì§ [Socket.IO] Received send-msg event - From: ${from} - To: ${to} - Message ID: ${_id} - Content: ${message}`
  //   );
  //   const onlineUsers = getOnlineUsers();
  //   // console.log("Current online users:", onlineUsers);
  //   const receiverSocketId = onlineUsers.get(to);
  //   console.log("Receiver socket ID:", receiverSocketId);
  //   if (receiverSocketId) {
  //     // Log khi g·ª≠i msg-receive ƒë·∫øn ng∆∞·ªùi nh·∫≠n, bao g·ªìm n·ªôi dung tin nh·∫Øn
  //     console.log(
  //       `üì• [Socket.IO] Emitting msg-receive to receiver - To: ${to} - Socket ID: ${receiverSocketId} - Content: ${message}`
  //     );
  //     socket.to(receiverSocketId).emit("msg-receive", {
  //       from,
  //       to,
  //       message,
  //       createdAt,
  //       isImage: isImage || false,
  //       fileUrls: fileUrls || [],
  //       _id,
  //     });
  //   } else {
  //     console.log(`[Socket.IO] Receiver is offline - To: ${to}`);
  //   }

  //   const senderSocketId = getOnlineUsers().get(from);
  //   if (senderSocketId) {
  //     // Log khi g·ª≠i msg-receive ƒë·∫øn ng∆∞·ªùi g·ª≠i, bao g·ªìm n·ªôi dung tin nh·∫Øn
  //     console.log(
  //       `üì• [Socket.IO] Emitting msg-receive to sender - To: ${from} - Socket ID: ${senderSocketId} - Content: ${message}`
  //     );
  //     socket.to(senderSocketId).emit("msg-receive", {
  //       from,
  //       to,
  //       message,
  //       createdAt,
  //       isImage: isImage || false,
  //       fileUrls: fileUrls || [],
  //       _id,
  //     });
  //   } else {
  //     console.log(`[Socket.IO] Sender is offline - From: ${from}`);
  //   }
  // });

  // // G·ª≠i y√™u c·∫ßu k·∫øt b·∫°n
  // socket.on("sendFriendRequest", (data) => {
  //   const { toUserId, fromUserId } = data;
  //   const sendUserSocket = getOnlineUsers().get(toUserId);
  //   if (sendUserSocket) {
  //     socket.to(sendUserSocket).emit("receiveFriendRequest", {
  //       fromUserId,
  //     });
  //   }
  // });

  // // X√≥a tin
  // socket.on("delete-msg", (data) => {
  //   io.emit("msg-delete", { messageId: data.messageId });
  // });

  // // Thu h·ªìi tin
  // socket.on("recall-msg", (data) => {
  //   io.emit("msg-recall", { messageId: data.messageId });
  // });

  // // Chuy·ªÉn ti·∫øp tin nh·∫Øn
  // socket.on("forward-msg", (data) => {
  //   const sendUserSocket = getOnlineUsers().get(data.to);
  //   if (sendUserSocket) {
  //     socket.to(sendUserSocket).emit("msg-receive", {
  //       from: data.from,
  //       message: data.message,
  //       createdAt: new Date(),
  //     });
  //   }
  // });

  // // X√≥a tin nh·∫Øn cho b·∫£n th√¢n
  // socket.on("delete-msg-for-me", (data) => {
  //   const { messageId, userId } = data;
  //   io.to(getOnlineUsers().get(userId)).emit("msg-deleted-for-me", {
  //     messageId,
  //   });
  // });

  // X·ª≠ l√Ω x√≥a l·ªãch s·ª≠ chat
  socket.on("delete-conversation", (data) => {
    const { userId1, userId2 } = data;

    // G·ª≠i th√¥ng b√°o ƒë·∫øn userId1 n·∫øu h·ªç ƒëang online
    const user1Socket = getOnlineUsers().get(userId1);
    if (user1Socket) {
      socket.to(user1Socket).emit("delete-conversation", {
        userId1,
        userId2,
      });
    }

    // G·ª≠i th√¥ng b√°o ƒë·∫øn userId2 n·∫øu h·ªç ƒëang online
    const user2Socket = getOnlineUsers().get(userId2);
    if (user2Socket) {
      socket.to(user2Socket).emit("delete-conversation", {
        userId1,
        userId2,
      });
    }
  });

  // G·ªçi ƒëi·ªán / video call
  // G·ªçi ƒëi·ªán / video call ƒë√£ s·ª≠a
  socket.on("callUser", (data) => {
    const { userToCall, signalData, from, name } = data;
    const userToCallSocket = getOnlineUsers().get(userToCall);

    if (userToCallSocket) {
      // Ng∆∞·ªùi nh·∫≠n online, g·ª≠i th√¥ng b√°o cu·ªôc g·ªçi
      io.to(userToCallSocket).emit("callUser", {
        signal: signalData,
        from,
        name,
      });

      // Thi·∫øt l·∫≠p th·ªùi gian ch·ªù (30 gi√¢y) ƒë·ªÉ ng∆∞·ªùi nh·∫≠n tr·∫£ l·ªùi
      const timeout = setTimeout(() => {
        const callerSocket = getOnlineUsers().get(from);
        const receiverSocket = getOnlineUsers().get(userToCall);
        if (callerSocket) {
          io.to(callerSocket).emit("callFailed", {
            reason: "Ng∆∞·ªùi d√πng kh√¥ng tr·∫£ l·ªùi",
          });
        }
        if (receiverSocket) {
          io.to(receiverSocket).emit("callEnded");
        }
      }, 30000);

      // L∆∞u timeout v√†o socket ƒë·ªÉ c√≥ th·ªÉ h·ªßy n·∫øu ng∆∞·ªùi nh·∫≠n tr·∫£ l·ªùi
      socket.callTimeout = timeout;
    } else {
      // Ng∆∞·ªùi nh·∫≠n offline, th√¥ng b√°o cho ng∆∞·ªùi g·ªçi
      const callerSocket = getOnlineUsers().get(from);
      if (callerSocket) {
        io.to(callerSocket).emit("callFailed", {
          reason: "Ng∆∞·ªùi d√πng ƒëang offline",
        });
      }
    }
  });
  //ƒë√£ s·ª≠a11111111
  socket.on("answerCall", (data) => {
    const { to, signal } = data;
    const callerSocket = getOnlineUsers().get(to);
    if (callerSocket) {
      io.to(callerSocket).emit("callAccepted", signal);

      // H·ªßy timeout n·∫øu ng∆∞·ªùi nh·∫≠n tr·∫£ l·ªùi
      const callerSocketInstance = Array.from(io.sockets.sockets.values()).find(
        (s) => s.id === callerSocket
      );
      if (callerSocketInstance && callerSocketInstance.callTimeout) {
        clearTimeout(callerSocketInstance.callTimeout);
        callerSocketInstance.callTimeout = null;
      }
    }
  });

  //ƒë√£ s·ª≠a11111111
  socket.on("rejectCall", (data) => {
    const { to } = data;
    const callerSocket = getOnlineUsers().get(to);
    if (callerSocket) {
      io.to(callerSocket).emit("callRejected", {
        reason: "Cu·ªôc g·ªçi b·ªã t·ª´ ch·ªëi",
      });

      // H·ªßy timeout n·∫øu ng∆∞·ªùi nh·∫≠n t·ª´ ch·ªëi
      const callerSocketInstance = Array.from(io.sockets.sockets.values()).find(
        (s) => s.id === callerSocket
      );
      if (callerSocketInstance && callerSocketInstance.callTimeout) {
        clearTimeout(callerSocketInstance.callTimeout);
        callerSocketInstance.callTimeout = null;
      }
    }
  });

  // X·ª≠ l√Ω s·ª± ki·ªán typing
  socket.on("typing", (data) => {
    const { to, from } = data;
    const sendUserSocket = getOnlineUsers().get(to);
    if (sendUserSocket) {
      socket.to(sendUserSocket).emit("typing", { from, to });
    }
  });

  // X·ª≠ l√Ω s·ª± ki·ªán stop-typing
  socket.on("stop-typing", (data) => {
    const { to, from } = data;
    const sendUserSocket = getOnlineUsers().get(to);
    if (sendUserSocket) {
      socket.to(sendUserSocket).emit("stop-typing", { from, to });
    }
  });
  //ƒë√£ s·ª≠a:
  /// Th√™m s·ª± ki·ªán pin-message
  socket.on("pin-message", async (data) => {
    const { from, to, messageId } = data;
    try {
      // T√¨m tin nh·∫Øn c·∫ßn ghim
      const message = await MessageModel.findById(messageId).populate("sender");
      if (!message) {
        console.log(`Message ${messageId} not found`);
        return;
      }

      // T√¨m t·∫•t c·∫£ tin nh·∫Øn ƒë√£ ghim trong cu·ªôc tr√≤ chuy·ªán (gi·∫£ s·ª≠ from v√† to x√°c ƒë·ªãnh cu·ªôc tr√≤ chuy·ªán)
      const pinnedMessages = await MessageModel.find({
        users: { $all: [from, to] },
        pinned: true,
      }).sort({ createdAt: 1 }); // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o, c≈© nh·∫•t tr∆∞·ªõc

      // N·∫øu ƒë√£ c√≥ 2 tin nh·∫Øn ghim, b·ªè ghim tin nh·∫Øn c≈© nh·∫•t
      if (pinnedMessages.length >= 2) {
        const oldestPinned = pinnedMessages[0];
        await MessageModel.findByIdAndUpdate(oldestPinned._id, {
          pinned: false,
        });
        const receiverSocket = getOnlineUsers().get(to);
        if (receiverSocket) {
          socket
            .to(receiverSocket)
            .emit("unpin-message", { messageId: oldestPinned._id });
        }
      }

      // Ghim tin nh·∫Øn m·ªõi
      await MessageModel.findByIdAndUpdate(messageId, { pinned: true });

      // L·∫•y l·∫°i danh s√°ch tin nh·∫Øn ghim m·ªõi
      const updatedPinnedMessages = await MessageModel.find({
        users: { $all: [from, to] },
        pinned: true,
      })
        .sort({ createdAt: -1 })
        .populate("sender");

      const pinnedMessagesData = updatedPinnedMessages.map((msg) => ({
        messageId: msg._id,
        senderName: msg.sender.username || "Unknown",
        content:
          msg.message.text || (msg.message.files.length > 0 ? "[Media]" : ""),
        isImage:
          msg.message.files.length > 0 && msg.message.files[0].type === "image",
        fileUrls:
          msg.message.files.length > 0
            ? msg.message.files.map((file) => file.url)
            : [],
      }));

      const receiverSocket = getOnlineUsers().get(to);
      if (receiverSocket) {
        socket.to(receiverSocket).emit("update-pinned-messages", {
          pinnedMessages: pinnedMessagesData,
        });
        console.log(
          `[Socket.IO] Emitted update-pinned-messages to ${to} - Messages: ${JSON.stringify(
            pinnedMessagesData
          )}`
        );
      }
    } catch (error) {
      console.error("Error in pin-message:", error);
    }
  });

  // Th√™m s·ª± ki·ªán unpin-message
  socket.on("unpin-message", async (data) => {
    const { from, to, messageId } = data;
    try {
      // B·ªè ghim tin nh·∫Øn
      await MessageModel.findByIdAndUpdate(messageId, { pinned: false });

      // L·∫•y l·∫°i danh s√°ch tin nh·∫Øn ghim m·ªõi
      const updatedPinnedMessages = await MessageModel.find({
        users: { $all: [from, to] },
        pinned: true,
      })
        .sort({ createdAt: -1 })
        .populate("sender");
      const pinnedMessagesData = updatedPinnedMessages.map((msg) => ({
        messageId: msg._id,
        senderName: msg.sender.username || "Unknown",
        content:
          msg.message.text || (msg.message.files.length > 0 ? "[Media]" : ""),
        isImage:
          msg.message.files.length > 0 && msg.message.files[0].type === "image",
        fileUrls:
          msg.message.files.length > 0
            ? msg.message.files.map((file) => file.url)
            : [],
      }));

      const receiverSocket = getOnlineUsers().get(to);
      if (receiverSocket) {
        socket.to(receiverSocket).emit("update-pinned-messages", {
          pinnedMessages: pinnedMessagesData,
        });
        console.log(
          `[Socket.IO] Emitted update-pinned-messages to ${to} - Messages: ${JSON.stringify(
            pinnedMessagesData
          )}`
        );
      }
    } catch (error) {
      console.error("Error in unpin-message:", error);
    }
  });

  // //ƒë√£ s·ª≠a
  // socket.on("joinGroup", ({ groupId }) => {
  //   socket.join(groupId);
  //   console.log(`User ${socket.id} joined group ${groupId}`);
  // });

  // // X·ª≠ l√Ω s·ª± ki·ªán th√™m th√†nh vi√™n (global)
  // socket.on("addMember", ({ groupId, memberIds }) => {
  //   io.emit("memberAdded", { groupId, memberIds });
  //   console.log(
  //     `üì¢ [Socket.IO] Emitted global memberAdded for group ${groupId}`
  //   );
  // });

  // // X·ª≠ l√Ω s·ª± ki·ªán ƒë·ªïi t√™n nh√≥m (global)
  // socket.on("renameGroup", ({ groupId, newName }) => {
  //   io.emit("groupRenamed", { groupId, newName });
  //   console.log(
  //     `üì¢ [Socket.IO] Emitted global groupRenamed for group ${groupId}`
  //   );
  // });

  // X·ª≠ l√Ω s·ª± ki·ªán c·∫≠p nh·∫≠t avatar (global)
  // socket.on("updateGroupAvatar", ({ groupId, avatar }) => {
  //   io.emit("avatarUpdated", { groupId, avatar });
  //   console.log(
  //     `üì¢ [Socket.IO] Emitted global avatarUpdated for group ${groupId}`
  //   );
  // });

  // // X·ª≠ l√Ω s·ª± ki·ªán r·ªùi nh√≥m (global)
  // socket.on("leaveGroup", ({ groupId, memberId }) => {
  //   io.emit("memberLeft", { groupId, memberId });
  //   console.log(
  //     `üì¢ [Socket.IO] Emitted global memberLeft for group ${groupId}`
  //   );
  // });

  // Ng·∫Øt k·∫øt n·ªëi
  socket.on("disconnect", () => {
    console.log("‚ùå Socket disconnected:", socket.id);
    removeUserBySocketId(socket.id);
    console.log(
      "Current online users after disconnect:",
      Array.from(getOnlineUsers().entries())
    );
  });
});

const PORT = process.env.PORT || 5000;

server.listen(PORT, "0.0.0.0", () =>
  console.log(`üöÄ Server ch·∫°y tr√™n c·ªïng ${PORT}`)
);
